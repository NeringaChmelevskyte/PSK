@model IEnumerable<Application.Entities.Trip>



<div id="myModalFlightDetails" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title"><span id="eventTitle"></span></h4>
            </div>
            <div class="modal-body">
                <p id="pDetails"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div id="myModalFlightInfo" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title"><span id="eventTitle"></span></h4>
            </div>
            <div class="modal-body">
                <p id="pDetails"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div id="myModal2" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Add flight</h4>
            </div>
            <div class="modal-body">

                <form id='formFlight' style='border:2px solid green; padding:7px;'>
                    <label>Departure:</label><br />
                    <label>Time:</label>
                    <div class="input-group date" id="dtflight1">
                        <input type="text" id="txtStart" class="form-control" />
                        <span class="input-group-addon">
                            <span class="glyphicon glyphicon-calendar">
                            </span>
                        </span>
                    </div>
                    <br />
                    <label>Arrival:</label><br />

                    <label>Time:</label>
                    <div class="input-group date" id="dtflight2">
                        <input type="text" id="txtEnd" class="form-control" />
                        <span class="input-group-addon">
                            <span class="glyphicon glyphicon-calendar">
                            </span>
                        </span>
                    </div>
                    <label>Price:</label>
                    <input type="number" min="0.01" step="0.01" value="0" id="flightPrice" name="flightPrice" placeHolder="0"><br />
                    <input type="button" class="btn btn-success" id="btnFlightSubmit" value="submit">
                </form>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<p>
    <a asp-action="Create">Create New</a>
</p>
<table class="table">
    <thead>
        <tr>
            <th>
                @Html.DisplayNameFor(model => model.Title)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.Start)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.End)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.FromOffice)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.ToOffice)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.TripStatus)
            </th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        @foreach (var item in Model)
        {
            <tr>
                <td>
                    @Html.DisplayFor(modelItem => item.Title)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.Start)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.End)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.FromOffice)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.ToOffice)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.TripStatus)
                </td>
                <td>
                    @*<a asp-action="Edit" asp-route-id="@item.Id">Edit</a> |
        <a asp-action="Details" asp-route-id="@item.Id">Details</a> |
        <a asp-action="Delete" asp-route-id="@item.Id">Delete</a>
        <button type="button" class="btn btn-default" id="btnTripDetails">Details</button> *@
                    
                    <a href='#' class='btnTripDetails' id='@item.Id'>Details</a>
                </td>
            </tr>
        }
    </tbody>
</table>

@section Scripts{
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.4.0/fullcalendar.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/js/bootstrap-datetimepicker.min.js"></script>
    <script>
        $(document).ready(function () {
            var trip = [];
            var tripId = null;
            var flight = [];
            var events = [];
            var selectedTrip = null;
            

            function SaveFlight(data) {
                $.ajax({
                    type: "POST",
                    url: '/Trips/AddFlight',
                    data: data,
                    success: function (status) {
                        if (status) {
                            $('#myModal2').modal('hide');
                        }
                    },
                    error: function () {
                        alert('Failed');
                    }
                })
            }

            $('.btnTripDetails').on('click', function (event) {
                tripId = event.target.id;

                getTripById(tripId);

                return;
            })

            function GenerateCalender(events) {
                $('#calender').fullCalendar('destroy');
                $('#calender').fullCalendar({
                    contentHeight: 400,
                    defaultDate: new Date(),
                    timeFormat: 'h(:mm)a',
                    header: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'month,basicWeek,basicDay,agenda'
                    },
                    eventLimit: true,
                    eventColor: '#378006',
                    events: events,
                    eventClick: function (calEvent, jsEvent, view) {
                        selectedEvent = calEvent;
                        $('#myModal #eventTitle').text(calEvent.title);
                        var $description = $('<div/>');
                        $description.append($('<p/>').html('<b>Start:</b>' + calEvent.start.format("YYYY-MM-DD hh:mm a")));
                        if (calEvent.end != null) {
                            $description.append($('<p/>').html('<b>End:</b>' + calEvent.end.format("YYYY-MM-DD hh:mm a")));
                        }
                        $description.append($('<p/>').html('<b>Description:</b>' + calEvent.description));
                        $description.append($('<p/>').html('<b>Lektuvo bilietai:</b>' + ' yra' + ' <button type="button" id="btnFlightAdd" class="btn btn-defaulk"> Add flight tickets</button>' ));
                        $description.append($('<p/>').html('<b>Nuomojama masina:</b>' + ' nera'));
                        $description.append($('<p/>').html('<b>Apgyvendinimas:</b>' + ' apartamentai'));
                        $('#myModal #pDetails').empty().html($description);
                        $('#myModal').modal();
                    }
                })
            }

            function getTripById(tripId) {
                
                trip = [];
                $.ajax({
                    type: "Get",
                    url: '/Trips/GetTrip/' + tripId,
                    dataType: "json",
                    success: function (data) {
                        $.each(data, function (i, v) {
                            trip.push({
                                id: v.id,
                                title: v.title,
                                start: moment(v.start),
                                end: v.end != null ? moment(v.end) : null,
                                fromOffice: v.fromOffice,
                                toOffice: v.toOffice,
                                tripStatus: v.tripStatus
                            });
                        })

                        $.each(trip, function (i, v) {
                            tripId = v.id;
                            $('#myModalFlightDetails #eventTitle').text(v.title);
                            var $description = $('<div/>');
                            $description.append($('<p/>').html('<b>Start:</b>' + v.start.format("YYYY-MM-DD hh:mm a")));
                            if (v.end != null) {
                                $description.append($('<p/>').html('<b>End:</b>' + v.end.format("YYYY-MM-DD hh:mm a")));
                            }
                            
                            $description.append($('<p/>').html('<b>Lektuvo bilietai:</b>' + ' yra' + ' <button type="button" id="btnFlightAdd" class="btn btn-defaulk"> Add flight tickets</button>' + '&nbsp' + '<button type="button" id="btnFlightInfo" class="btn btn-defaulk">Flight info</button>'));
                            $description.append($('<p/>').html('<b>Nuomojama masina:</b>' + ' nera'));
                            $description.append($('<p/>').html('<b>Apgyvendinimas:</b>' + ' apartamentai'));
                            $('#myModalFlightDetails #pDetails').empty().html($description);
                            $('#myModalFlightDetails').modal();

                        })

                    },
                    error: function () {
                        alert('Failed');
                    }
                })
            }

            $('#myModalFlightDetails').on('click', '#btnFlightAdd', function () {

                $('#myModal2').modal();
                return;
            })

            $('#myModalFlightDetails').on('click', '#btnFlightInfo', function () {

                $('#myModalFlightInfo').modal();
                getFlightById(tripId);
                return;
            })


            $('#dtflight1, #dtflight2').datetimepicker({
                format: 'YYYY-MM-DD hh:mm a'
            });

            $('#myModal2').on('click', '#btnFlightSubmit', function () {
                var data = {
                    TripId: tripId, // TODO: reikes pakeisti i trip ir tripId
                    Cost: $('#flightPrice').val(),
                    Start: $('#txtStart').val().trim(), // TODO: reikes pakeist i trip
                    End: $('#txtEnd').val().trim(),  // TODO: reikes pakeist i trip
                    FlightTicketStatus: 1 // TODO: add logic
                }
                SaveFlight(data);
            })

            function getFlightById(tripId) {

                flight = [];
                $.ajax({
                    type: "Get",
                    url: '/Trips/GetFlight/' + tripId,
                    dataType: "json",
                    success: function (data) {

                        $.each(data, function (i, v) {
                            flight.push({
                                id: v.id,
                                tripId: v.tripId,
                                cost: v.cost,
                                start: moment(v.start),
                                end: v.end != null ? moment(v.end) : null,
                                flightTicketStatus: v.flightTicketStatus
                            });
                            console.log(flight);
                        })

                        $.each(flight, function (i, v) {
                            
                            $('#myModalFlightInfo #eventTitle').text("Flight info");
                            var $description = $('<div/>');
                            $description.append($('<p/>').html('<b>Trip Id:</b>' + v.tripId));
                            $description.append($('<p/>').html('<b>Cost:</b>' + v.cost));
                            $description.append($('<p/>').html('<b>Start:</b>' + v.start.format("YYYY-MM-DD hh:mm a")));
                            if (v.end != null) {
                                $description.append($('<p/>').html('<b>End:</b>' + v.end.format("YYYY-MM-DD hh:mm a")));
                            }
                            $description.append($('<p/>').html('<b>Flight ticket status:</b>' + v.flightTicketStatus));

                            
                            $('#myModalFlightInfo #pDetails').empty().html($description);
                            $('#myModalFlightInfo').modal();

                        })
                        
                    },
                    error: function () {
                        alert('Failed');
                    }
                })
            }
        })
    </script>
}
